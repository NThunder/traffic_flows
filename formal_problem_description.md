# Формальная постановка задачи: Минимизация вероятности опоздания в транспортной системе

## Введение

Классический алгоритм Флориана решает задачу поиска оптимальной стратегии передвижения в транспортной системе, минимизируя ожидаемые обобщенные затраты (время ожидания + время в пути + штрафы за пересадки). Однако в ряде случаев, особенно при поездках на работу/учебу к определенному времени, более важной метрикой является не среднее время поездки, а вероятность прибыть вовремя.

## Обозначения

- $ G = (V, E) $ — транспортная сеть, где $ V $ — множество остановок, $ E $ — множество дуг (переездов между остановками)
- $ s \in V $ — начальная остановка
- $ t \in V $ — конечная остановка (目的地)
- $ T $ — фиксированное время, к которому необходимо прибыть
- $ \pi $ — стратегия передвижения (hyperpath), состоящая из множества допустимых линий на каждой остановке
- $ P(\text{arrive on time}|\pi, s, t, T) $ — вероятность прибыть в пункт назначения вовремя, используя стратегию $ \pi $

## Классическая модель Флориана

В классической модели для каждой дуги $ e \in E $ определяется обобщенная стоимость $ c_e $, а задача сводится к минимизации:
$$ \min_{\pi} \sum_{e \in \pi} c_e $$

Где $ c_e $ включает:
- Время в пути
- Время ожидания
- Штрафы за пересадки

## Предлагаемая модель 1: Минимизация вероятности опоздания (lateness_prob_florian.py)

### Целевая функция

Вместо минимизации ожидаемых затрат, мы максимизируем вероятность прибытия к заданному времени $ T $:
$$ \max_{\pi} P(\text{arrive before time } T|\pi, s, t) $$

Что эквивалентно:
$$ \min_{\pi} P(\text{late arrival}|\pi, s, t, T) $$

### Вероятностная модель времени прибытия

Для моделирования вероятности опоздания, каждое ребро $ e $ будет характеризоваться не фиксированной стоимостью, а случайной величиной $ X_e $ — временем прохождения этого ребра. 

Предположим, что $ X_e $ имеет нормальное распределение:
$$ X_e \sim N(\mu_e, \sigma_e^2) $$

Где:
- $ \mu_e $ — среднее время прохождения ребра $ e $
- $ \sigma_e $ — стандартное отклонение, отражающее вариабельность времени из-за задержек, пробок и т.д.

### Вычисление вероятности для гиперпути

Для гиперпути (hyperpath) $ H $, состоящего из последовательности ребер $ e_1, e_2, ..., e_k $, общее время пути $ X_H $ будет суммой случайных величин:
$$ X_H = \sum_{i=1}^{k} X_{e_i} $$

Если предположить независимость случайных величин, то:
$$ X_H \sim N\left(\sum_{i=1}^{k} \mu_{e_i}, \sum_{i=1}^{k} \sigma_{e_i}^2\right) $$

Тогда вероятность прибытия до времени $ T $:
$$ P(X_H \leq T) = \Phi\left(\frac{T - \sum_{i=1}^{k} \mu_{e_i}}{\sqrt{\sum_{i=1}^{k} \sigma_{e_i}^2}}\right) $$

где $ \Phi $ — кумулятивная функция стандартного нормального распределения.

### Обобщение на случай стратегии Флориана

В алгоритме Флориана мы имеем дело не с фиксированным маршрутом, а со стратегией, когда на каждой остановке пассажир выбирает из нескольких возможных направлений. Для вычисления вероятности прибытия при стратегии необходимо использовать принцип динамического программирования, аналогично оригинальному алгоритму, но с использованием вероятностных характеристик.

Пусть $ U(i) $ — максимальная вероятность прибытия вовремя из остановки $ i $ в конечную точку. Тогда:

$$ U(i) = \max_{a=(i,j) \in A(i)} \left[ \int_{-\infty}^{\infty} f_{ij}(t) \cdot U(j, t + c_{ij}) dt \right] $$

где:
- $ A(i) $ — множество допустимых дуг из остановки $ i $
- $ f_{ij}(t) $ — плотность распределения времени ожидания и прохождения дуги $ (i,j) $
- $ U(j, t) $ — максимальная вероятность прибытия вовремя из остановки $ j $ при начале в момент времени $ t $

### Упрощенная модель для реализации

Для практической реализации будем использовать следующую модель:

1. Каждая дуга $ e $ характеризуется:
   - $ \mu_e $ — среднее время прохождения
   - $ \sigma_e $ — стандартное отклонение времени прохождения
   - $ h_e $ — интервал движения (headway)

2. Время ожидания на остановке для линии с интервалом $ h $ также моделируется как случайная величина, равномерно распределенная на интервале $ [0, h/2] $ в среднем, с соответствующей дисперсией.

3. Итоговое время пути складывается из:
   - Времени ожидания
   - Времени в пути
   - Дисперсии каждого компонента

### Алгоритмическая реализация

Алгоритм будет модификацией алгоритма Флориана, где:
- Вместо минимизации обобщенных затрат, происходит максимизация вероятности прибытия вовремя
- Метки на вершинах будут представлять вероятность успешного прибытия
- При обновлении меток будет использоваться вероятностная модель времени

## Преимущества предлагаемого подхода

1. **Более реалистичная модель поведения пассажиров**: Люди действительно стремятся минимизировать риск опоздания, а не просто среднее время в пути.

2. **Учет неопределенности**: Модель учитывает вариабельность времени в пути, что особенно важно для утренних поездок, когда время прибытия критично.

3. **Применимость к утренним потокам**: Как предполагается в задаче, такой подход может лучше моделировать утренние пассажиропотоки, когда люди стремятся прибыть на работу/учебу к определенному времени с высокой вероятностью.

## Заключение

Предлагаемая модель представляет собой развитие классического алгоритма Флориана, адаптированное для задач, где критичным фактором является не среднее время поездки, а вероятность прибытия вовремя. Это особенно актуально для моделирования утренних пассажиропотоков в крупных городах.